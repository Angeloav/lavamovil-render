<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- √çcono de pesta√±a (favicon) -->
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
  
  <title>Cliente - LavaMovil</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #121212;
      color: #ffffff;
      margin: 0; padding: 0;
      text-align: center;
    }
    .notificacion {
      background-color: #d1f0f8;
      color: #000;
      padding: 15px;
      font-size: 14px;
      text-align: left;
      border-radius: 0 0 15px 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .notificacion strong {
      color: #c0392b;
      display: block;
    }
    h1 {
      font-size: 24px;
      color: #ffffff;
      margin-top: 20px;
    }
    p {
      color: #ffffff;
      font-size: 14px;
      margin-bottom: 20px;
    }
    h3 {
      color: #ffffff;
    }
    #map {
      height: 250px;
      width: 90%;
      max-width: 360px;
      margin: 0 auto 20px;
      border-radius: 20px;
      border: 1px solid #333;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    }
    button {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 85%;
      max-width: 320px;
      margin: 10px auto;
      padding: 14px;
      border: 2px solid #aaa;
      border-radius: 30px;
      font-size: 16px;
      font-weight: 600;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }
    .solicitar { background-color: #007bff; }
    .cancelar  { background-color: #dc3545; }
    .finalizar { background-color: #28a745; }
    .cerrar    { background-color: #616161; }
    .solicitar:hover  { background-color: #0056b3; }
    .cancelar:hover   { background-color: #a71d2a; }
    .finalizar:hover  { background-color: #1c7c31; }
    .cerrar:hover     { background-color: #1d2124; }
    #formularioCalificacion, .calificacion-box {
      width: 85%;
      max-width: 320px;
      margin: 20px auto;
      box-sizing: border-box;
    }
    select, textarea {
      width: 100%;
      max-width: 100%;
      padding: 12px;
      margin-top: 10px;
      border-radius: 8px;
      border: 1px solid #555;
      font-size: 14px;
      background-color: #2a2a2a;
      color: #ffffff;
      box-sizing: border-box;
    }
  </style>
</head>
<body style="margin:0; padding:0; overflow-x:hidden; background-color:#1e1e2f; color:white;">

  {% include 'notificaciones.html' %}
  <div id="mensajeLavador" class="notificacion" style="display: none;">
    <strong>Lavador en camino</strong>
    El lavador ha aceptado tu solicitud y va en camino
  </div>

  <h1>Bienvenido {{ cliente.nombre }} {{ cliente.apellido }}</h1>
  <p>ID de Usuario: {{ cliente.id }}</p>
  <div id="map"></div>

  <button class="solicitar"   onclick="guardarUbicacionYEnviar()">üöó Solicitar Servicio</button>
  <button class="cancelar"    onclick="cancelarSolicitud()">üóë Cancelar Solicitud</button>
  <button class="finalizar"   onclick="mostrarFormularioCalificacion()">‚≠ê Finalizar Servicio / Calificar</button>
  <button class="cerrar"      onclick="cerrarSesion()">‚û°Ô∏è Cerrar Sesi√≥n</button>

  <form action="/chat" method="get">
    <input type="hidden" name="rol" value="cliente">
    <button id="botonChat" type="submit" style="background-color: #6c63ff; color: white; padding: 10px; border-radius: 10px;">
      üí¨ Chat con Lavador
    </button>
  </form>

  <div id="formularioCalificacion" style="display: none;">
    <h3>Califica el servicio</h3>
    <select id="calificacion">
      <option value="Excelente">Excelente</option>
      <option value="Bueno">Bueno</option>
      <option value="Regular">Regular</option>
      <option value="Malo">Malo</option>
    </select>
    <textarea id="comentario" placeholder="Comentario (opcional)"></textarea>
    <button class="finalizar" onclick="enviarCalificacion()">Enviar Calificaci√≥n</button>
  </div>

  <audio id="sonidoMensaje" src="/static/sounds/nuevo_mensaje.mp3"></audio>

  <!-- ==================== SCRIPT PRINCIPAL ==================== -->
<script>
  const socket         = io();
  const clienteId      = {{ cliente.id }};
  let lavadorId        = {{ solicitud_activa.lavador_id if solicitud_activa else 'null' }};
  const tieneSolicitud = {{ 'true' if solicitud_activa else 'false' }};

  let map, lavadorMarker, clienteMarker, rutaPolyline;
  let ubicacionInicialGuardada = false;
  let solicitudAceptada = tieneSolicitud;

  if (solicitudAceptada) {
    document.getElementById("mensajeLavador").style.display = "block";
  }

  socket.on("notificacion_cliente", (data) => {
    if (data.cliente_id === clienteId && data.mensaje) {
      document.getElementById("mensajeLavador").style.display = "block";
      solicitudAceptada = true;
      // üîß PARCHE: unir chat si trae lavador_id
      if (data.lavador_id) lavadorId = data.lavador_id;
      joinSalaChatClienteSiListo();
    }
  });

  if (lavadorId && lavadorId !== "null" && lavadorId !== "none") {
    socket.emit("unirse_sala_privada", { cliente_id: clienteId, lavador_id: lavadorId });
  }

  socket.on("iniciar_movimiento", (data) => {
    if (data.cliente_id === clienteId && data.lavador_id === lavadorId) {
      solicitudAceptada = true;
      // üîß PARCHE: actualizar lavadorId y unir chat
      if (data.lavador_id) lavadorId = data.lavador_id;
      joinSalaChatClienteSiListo();
    }
  });

  socket.on("nueva_solicitud_aceptada", (data) => {
    if (data && data.cliente_id === clienteId && data.lavador_id) {
      lavadorId = data.lavador_id;
      solicitudAceptada = true;
      socket.emit("unirse_sala_privada", { cliente_id: clienteId, lavador_id: lavadorId });
      joinSalaChatClienteSiListo();
    }
  });

  // =======================
  // INICIO PARCHE CHAT CLIENTE
  // =======================
  let unidoChatCliente = false;

  function joinSalaChatClienteSiListo() {
    if (!lavadorId || lavadorId === "null" || lavadorId === "none") return;
    const C = Number(clienteId), L = Number(lavadorId);
    if (!Number.isFinite(C) || !Number.isFinite(L)) return;

    const sala = `chat_${Math.min(C, L)}_${Math.max(C, L)}`;
    if (!unidoChatCliente) {
      socket.emit("unirse_chat", { sala });
      unidoChatCliente = true;
      console.log("‚úÖ Cliente unido a", sala);
    }
  }

  socket.on("connect", () => {
    unidoChatCliente = false;
    joinSalaChatClienteSiListo();

    const t = setInterval(() => {
      if (unidoChatCliente) return clearInterval(t);
      joinSalaChatClienteSiListo();
    }, 1000);
  });

  socket.on("disconnect",        () => { unidoChatCliente = false; });
  socket.on("reconnect",         () => { unidoChatCliente = false; joinSalaChatClienteSiListo(); });
  socket.on("reconnect_attempt", () => { unidoChatCliente = false; });

  setInterval(() => {
    if (!unidoChatCliente) joinSalaChatClienteSiListo();
  }, 15000);

  socket.on("recibir_mensaje_privado", (data) => {
    console.log("üì• (cliente) mensaje:", data);
    const box = document.getElementById("mensajes") || document.body;
    const p = document.createElement("p");
    p.textContent = data.mensaje;
    box.appendChild(p);
    box.scrollTop = box.scrollHeight;
  });
  // =======================
  // FIN PARCHE CHAT CLIENTE
  // =======================

</script>


    <script>
    // INICIO PARCHE CHAT CLIENTE
    // =======================
    
    let unidoChatCliente = false;

    function joinSalaChatClienteSiListo() {
      if (!lavadorId || lavadorId === "null" || lavadorId === "none") return;
      const C = Number(clienteId), L = Number(lavadorId);
      if (!Number.isFinite(C) || !Number.isFinite(L)) return;

      const sala = `chat_${Math.min(C,L)}_${Math.max(C,L)}`;
      if (!unidoChatCliente) {
        socket.emit("unirse_chat", { sala });
        unidoChatCliente = true;
        console.log("‚úÖ Cliente unido a", sala);
      }
    }

    // re-unirse tras reconexi√≥n
    socket.on("connect", () => {
      unidoChatCliente = false;     // fuerza rejoin
      joinSalaChatClienteSiListo();
      const t = setInterval(() => {
        if (unidoChatCliente) return clearInterval(t);
        joinSalaChatClienteSiListo();
      }, 1000);
    });
    socket.on("disconnect", () => { unidoChatCliente = false; });

    // escuchar mensajes en vivo (si no lo tienes ya)
    socket.on("recibir_mensaje_privado", (data) => {
      console.log("üì• (cliente) mensaje:", data);
      const box = document.getElementById("mensajes") || document.body;
      const p = document.createElement("p");
      p.textContent = data.mensaje;
      box.appendChild(p);
      box.scrollTop = box.scrollHeight;
    });
    // =======================
    // FIN PARCHE CHAT CLIENTE
    // =======================
    </script>

    <script>
    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 19.4326, lng: -99.1332 },
        zoom: 15
      });

      // Colocar marcador inicial del cliente
      navigator.geolocation.getCurrentPosition(position => {
        const clientePos = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };
        map.setCenter(clientePos);
        clienteMarker = new google.maps.Marker({
          position: clientePos,
          map: map,
          title: "Tu ubicaci√≥n",
          icon: {
            url: "/static/icons/carrito_icono.png",
            scaledSize: new google.maps.Size(50, 50)
          }
        });

        if (!ubicacionInicialGuardada) {
          guardarUbicacionAlCargar(clientePos.lat, clientePos.lng);
          ubicacionInicialGuardada = true;
        }

      }, error => {
        // Si falla geolocalizaci√≥n, usar coordenadas fijas
        const clientePos = { lat: 43.0961502, lng: -75.2103744 };
        map.setCenter(clientePos);
        clienteMarker = new google.maps.Marker({
          position: clientePos,
          map: map,
          title: "Ubicaci√≥n estimada",
          icon: {
            url: "/static/icons/carrito_icono.png",
            scaledSize: new google.maps.Size(50, 50)
          }
        });
        if (!ubicacionInicialGuardada) {
          guardarUbicacionAlCargar(clientePos.lat, clientePos.lng);
          ubicacionInicialGuardada = true;
        }
      }, {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      });

      // Cada 5s, si la solicitud fue aceptada, consultamos ubicaci√≥n del lavador
      setInterval(() => {
        if (solicitudAceptada) {
          obtenerUbicacionLavador();
        }
      }, 5000);
    }

    window.initMap = initMap; // üëâ Esto hace visible la funci√≥n para Google Maps
    if (window.google && window.google.maps) { initMap(); }
    </script>
    
    <script>
    if (solicitudAceptada) {
    iniciarMovimientoCarritoCamioncito();
    }

    function iniciarMovimientoCarritoCamioncito() {
      // Llamada inmediata para no esperar 5 segundos
      obtenerUbicacionLavador();
    }

    function obtenerUbicacionLavador() {
      if (!lavadorId || lavadorId === "none") return;

      fetch(`/obtener_ubicacion_lavador?user_id=${lavadorId}`, {
        credentials: 'include'
      })
      .then(response => response.json())
      .then(data => {
        console.log("üì° Datos recibidos del lavador:", data);  // üîç Registro agregado

        if (data.lat && data.lng) {
          const lavadorPos = { lat: data.lat, lng: data.lng };
          if (!lavadorMarker) {
            lavadorMarker = new google.maps.Marker({
              position: lavadorPos,
              map: map,
              title: "Lavador en camino",
              icon: {
                url: "/static/icons/camioncito_icono.png",
                scaledSize: new google.maps.Size(50, 50)
              }
            });
          } else {
            lavadorMarker.setPosition(lavadorPos);
          }
          if (clienteMarker && lavadorMarker) {
            if (rutaPolyline) rutaPolyline.setMap(null);
            rutaPolyline = new google.maps.Polyline({
              path: [lavadorPos, clienteMarker.getPosition()],
              geodesic: true,
              strokeColor: "#00ff00",
              strokeOpacity: 0.8,
              strokeWeight: 4
            });
            rutaPolyline.setMap(map);
          }
        }
      })
      .catch(err => console.warn("‚ö†Ô∏è Error en obtenerUbicacionLavador():", err));
    }

    // ==================== FUNCIONES EXISTENTES (sin modificar) ====================
    function guardarUbicacionYEnviar() {
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        latitudCliente = lat;
        longitudCliente = lng;

        fetch('/actualizar_ubicacion_cliente', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ latitud: lat, longitud: lng })
        })
        .then(res => {
          if (!res.ok) console.error("‚ùå /actualizar_ubicacion_cliente devolvi√≥:", res.status);
          return res.json();
        })
        .then(data => {
          solicitarServicio();  // Llamamos a la funci√≥n que hace el emit y guarda el ID
        })
        .catch(err => {
          console.error("‚ùå Error en guardarUbicacionYEnviar():", err);
          alert("Error al actualizar la ubicaci√≥n.");
        });
      }, err => {
        console.error("‚ùå Error en geolocalizaci√≥n:", err);
        alert("No se pudo obtener tu ubicaci√≥n.");
      });
    }

    function solicitarServicio(latitudCliente, longitudCliente) {
      fetch("/solicitar_servicio", {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" }
      })
      .then(response => {
        if (!response.ok) throw new Error("Respuesta no OK del servidor");
        return response.json();
      })
      .then(data => {
        if (data.success) {
          alert("üöó Solicitud enviada correctamente.");
          console.log("üì° Solicitud creada y enviada al lavador (v√≠a servidor). ID:", data.solicitud_id);
        } else {
          alert("‚ùå No se pudo enviar la solicitud: " + (data.error || "Error desconocido."));
        }
      })
      .catch(err => {
        console.error("‚ùå Error en solicitarServicio():", err);
        alert("‚ùå Ocurri√≥ un error inesperado.");
      });
    }

    function cancelarSolicitud() {
      fetch("/cancelar_solicitud", {
        method: "POST",
        credentials: "include"
     })
     .then(res => res.json())
     .then(data => {
       if (data.redirect) {
         window.location.href = data.redirect;  // ‚¨Ö redirige a /solicitud_cancelada
       } else {
         alert(data.message || "üõë Solicitud cancelada.");
         location.reload(); // Solo si no hay redirecci√≥n
       }
    })
    .catch(err => {
      console.error("‚ùå Error en cancelarSolicitud():", err);
      alert("‚ùå Error al cancelar la solicitud.");
    });
  }

    function mostrarFormularioCalificacion() {
      document.getElementById("formularioCalificacion").style.display = "block";
    }

    function enviarCalificacion() {
      const calificacion = document.getElementById("calificacion").value;
      const comentario  = document.getElementById("comentario").value;
      fetch("/finalizar_servicio", {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ calificacion: calificacion, comentario: comentario })
      })
      .then(res => {
        if (!res.ok) console.error("‚ùå /finalizar_servicio devolvi√≥ c√≥digo:", res.status);
        return res.json();
      })
      .then(data => {
        alert(data.mensaje);
        if (data.mensaje.includes("calificado")) {
          window.location.href = "/cliente_dashboard";
        }
      })
      .catch(err => {
        console.error("‚ùå Error en enviarCalificacion():", err);
        alert("‚ùå Error al enviar la calificaci√≥n.");
      });
    }

    function cerrarSesion() {
      window.location.href = "/seleccion_rol";
    }
   
    // ==================== NOTIFICACIONES DE CHAT (sin modificar) ====================
    socket.emit("unirse_sala_mensajes", { user_id: clienteId });
    socket.on("nuevo_mensaje_directo", function(data) {
      if (data.destinatario_id === clienteId) {
        const botonChat = document.getElementById("botonChat");
        if (botonChat && !document.getElementById("burbujaChat")) {
          const burbuja = document.createElement("span");
          burbuja.id = "burbujaChat";
          burbuja.textContent = "üî¥";
          burbuja.style.marginLeft = "5px";
          botonChat.appendChild(burbuja);
        }
        const sonido = document.getElementById("sonidoMensaje");
        if (sonido) sonido.play();
      }
    });

    setInterval(() => {
      fetch("/verificar_mensajes_nuevos", {
        method: "GET",
        credentials: "include",
        cache: "no-store"
      })
      .then(res => res.ok ? res.json() : Promise.reject(res))
      .then(data => {
        if (!data) return;
        const btn = document.getElementById("botonChatCliente")   // üëà usa el id real del bot√≥n del cliente
                 || document.getElementById("botonChat");         // fallback si tu bot√≥n se llama as√≠
        if (data.mensajes_nuevos && btn && !document.getElementById("burbujaChatCliente")) {
          const b = document.createElement("span");
          b.id = "burbujaChatCliente";
          b.textContent = "üî¥";
          b.style.marginLeft = "6px";
          btn.appendChild(b);
        }
      })
      .catch(err => console.error("‚úò verificar_mensajes_nuevos (cliente):", err.status || err, err.statusText || ""));
    }, 5000);
</script>
<script>
let markerLavador; // si no lo tienes ya

function actualizarMarcadorLavador(lat, lng) {
  if (!window.map) return;
  const pos = { lat: Number(lat), lng: Number(lng) };
  if (!markerLavador) {
    markerLavador = new google.maps.Marker({
      position: pos,
      map: map,
      title: "Lavador",
      icon: { url: "/static/icons/camioncito_icono.png",
              scaledSize: new google.maps.Size(50, 50) }
    });
    map.setCenter(pos);
  } else {
    markerLavador.setPosition(pos);
  }
}

// üëá NUEVO: escucha la actualizaci√≥n ‚Äúpush‚Äù del lavador usando la sala de mensajes
socket.on("ubicacion_lavador", (data) => {
  // (opcional) si emites cliente_id, filtra:
  if (data?.cliente_id && data.cliente_id !== clienteId) return;

  const lat = data?.latitud ?? data?.lat;
  const lng = data?.longitud ?? data?.lng;
  if (lat != null && lng != null) {
    actualizarMarcadorLavador(lat, lng);
  }
});
</script>
  
<!-- ==================== SCRIPT SECUNDARIO: GEOLOCALIZACI√ìN C√çCLICA ==================== -->
<!-- INICIO PARCHE GEO √öNICO (CLIENTE) -->
<script>
  // Evita doble inicializaci√≥n
  if (!window._geoInitCliente) {
    window._geoInitCliente = true;

    // Pide 1 lectura al cargar (puedes dejar solo el intervalo si prefieres)
    if ("geolocation" in navigator) {
      navigator.geolocation.getCurrentPosition(
        guardarUbicacionAlCargar,          // acepta 'position'
        errorUbicacion,
        { enableHighAccuracy: true, maximumAge: 0, timeout: 12000 }
      );
    }
  }

  // Funci√≥n unificada: acepta (position) o (lat,lng)
  function guardarUbicacionAlCargar(a, b) {
    let lat, lng;

    if (a && typeof a === "object" && a.coords) {
      lat = a.coords.latitude;
      lng = a.coords.longitude;
    } else {
      lat = a;
      lng = b;
    }

    if (typeof lat !== "number" || typeof lng !== "number") {
      console.warn("‚ö†Ô∏è Coordenadas inv√°lidas en guardarUbicacionAlCargar:", { lat, lng, a, b });
      return;
    }

    // 1) Guardar en backend por fetch (como ya hac√≠as)
    fetch('/actualizar_ubicacion_cliente', {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ latitud: lat, longitud: lng })
    })
    .then(res => {
      if (!res.ok) {
        console.error("‚úò /actualizar_ubicacion_cliente:", res.status, res.statusText);
        return;
      }
      return res.json();
    })
    .then(data => {
      if (data) console.log("‚úî Ubicaci√≥n guardada:", data);
    })
    .catch(err => console.error("‚úò Error guardando ubicaci√≥n:", err));

    // 2) Emitir por Socket.IO (si est√° disponible)
    try {
      if (window.socket && typeof window.socket.emit === "function") {
        window.socket.emit("actualizar_ubicacion_cliente", {
          cliente_id: {{ cliente.id }},
          latitud: lat,
          longitud: lng
        });
      }
    } catch (e) { console.warn("‚ö†Ô∏è Emisi√≥n socket fall√≥:", e); }
  }

  function errorUbicacion(err){
    console.warn("‚ö†Ô∏è Geoloc:", err && err.message ? err.message : err);
  }

  // Tu funci√≥n peri√≥dica sigue igual, pero ahora reusa la unificada:
  function enviarUbicacionCliente() {
    if (!("geolocation" in navigator)) return;
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      console.log("üì§ Cliente envi√≥ ubicaci√≥n:", lat, lng);
      guardarUbicacionAlCargar(lat, lng); // ‚Üê reusa la misma
    }, errorUbicacion, { enableHighAccuracy: true, maximumAge: 0, timeout: 12000 });
  }

  // Mant√©n tu intervalo
  setInterval(enviarUbicacionCliente, 5000);

</script>
<!-- FIN PARCHE GEO √öNICO (CLIENTE) -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBmVCNKb_sjx-vE5b1YoJpPUgm8Ub09ElE&callback=initMap"></script>

</body>
</html>