<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel del Lavador - LavaMovil</title>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <style>
    body { font-family: 'Segoe UI', sans-serif; background-color: #121212; color: #ffffff; margin: 0; padding: 0; text-align: center; }
    h1 { color: #ffffff; font-size: 24px; margin-top: 20px; }
    p  { color: #ffffff; }
    #estado { margin-bottom: 10px; font-size: 15px; color: #ffffff; }

    #map {
      width: 90%; max-width: 360px; height: 250px;
      border-radius: 20px; margin: 20px auto;
      border: 1px solid #333; box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    }

    button {
      display: flex; align-items: center; justify-content: center;
      width: 85%; max-width: 320px; margin: 10px auto; padding: 14px;
      border: 2px solid #aaa; border-radius: 30px; font-size: 16px; font-weight: 600;
      color: white; cursor: pointer; transition: all 0.3s ease; box-sizing: border-box;
    }

    .activo { background-color: #28a745; }
    .inactivo { background-color: #dc3545; }
    .cerrar { background-color: #343a40; }
    .vercal { background-color: #007bff; }
    .activo:hover { background-color: #1c7c31; }
    .inactivo:hover { background-color: #a71d2a; }
    .cerrar:hover { background-color: #1d2124; }
    .vercal:hover { background-color: #0056b3; }

    #notificacion {
      display: none;
      background-color: #ffc107;
      padding: 15px;
      border-radius: 0 0 15px 15px;
      color: #000;
      margin-bottom: 10px;
      font-weight: bold;
    }

    .calificacion-box {
      background-color: #1e1e1e; border: 1px solid #555;
      margin: 20px auto; padding: 15px; border-radius: 12px;
      max-width: 360px; text-align: left; display: none; color: #ffffff;
      box-sizing: border-box; width: 85%;
    }

    .aceptar {
      background-color: #28a745;
      color: white;
      padding: 10px 18px;
      border: none;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 8px;
    }
    .aceptar:hover { background-color: #1c7c31; }

    select, textarea {
      width: 100%; max-width: 100%;
      padding: 12px; margin-top: 10px;
      border-radius: 8px; border: 1px solid #555;
      font-size: 14px; background-color: #2a2a2a; color: #ffffff;
      box-sizing: border-box;
    }
  </style>

  <!-- clienteId seguro (sin tocar DOM antes de tiempo) -->
  <script>
    let clienteId = "none";

    function refrescarClienteIdDesdeDOMyLS() {
      try {
        const el = document.getElementById("clienteData");
        if (el && el.dataset && el.dataset.id) clienteId = el.dataset.id;

        if (!clienteId || clienteId === "none") {
          const guardado = localStorage.getItem("lm_cliente_activo");
          if (guardado) clienteId = guardado;
        }

        if (clienteId && clienteId !== "none") {
          localStorage.setItem("lm_cliente_activo", String(clienteId));
          if (el) el.dataset.id = String(clienteId);
        }

        const hidden = document.getElementById("clienteIdHidden");
        if (hidden) hidden.value = (clienteId && clienteId !== "none") ? String(clienteId) : "";
      } catch (e) {}
    }

    document.addEventListener("DOMContentLoaded", () => {
      refrescarClienteIdDesdeDOMyLS();
    });
  </script>
</head>

<body>

{% include 'notificaciones.html' %}

<h1>Bienvenido Lavador {{ lavador.nombre }} {{ lavador.apellido }}</h1>
<p>ID de Usuario: {{ lavador.id }}</p>

<div id="estado">Estado: <span id="estadoServicio">{{ lavador.estado.capitalize() }}</span></div>

<div id="clienteData" data-id="{{ cliente.id if cliente else 'none' }}"></div>
<div id="solicitudAceptada" data-estado="{{ 'true' if solicitud_aceptada else 'false' }}"></div>
<div id="estadoSolicitud" data-aceptada="{{ 'true' if solicitud_activa and solicitud_activa.estado == 'aceptado' else 'false' }}"></div>

<div id="notificacion">¬°Nueva solicitud recibida!</div>
<div id="map"></div>

<button class="activo" onclick="cambiarEstado('activo')">üîî Activar</button>
<button class="inactivo" onclick="cambiarEstado('inactivo')">üîï Desactivar</button>
<button class="vercal" onclick="verCalificaciones()">‚≠ê Ver Calificaciones</button>
<button class="cerrar" onclick="cerrarSesion()">‚õî Cerrar Sesi√≥n</button>

<form action="/chat" method="get">
  <input type="hidden" name="rol" value="lavador">
  <input type="hidden" name="cliente_id" id="clienteIdHidden" value="">
  <button id="botonChat" type="submit" style="background-color: #6c63ff; color: white; padding: 10px; border-radius: 10px;">
    üí¨ Chat con Cliente
  </button>
</form>

<div id="solicitudes"></div>
<div id="calificaciones" class="calificacion-box"></div>
<audio id="sonidoMensaje" src="/static/sounds/nuevo_mensaje.mp3"></audio>

<script>
  // ====== IDs ======
  const lavadorId = {{ lavador.id|tojson }};

  // ====== Socket (UNA sola instancia) ======
  window.socket = io(window.location.origin, {
    transports: ["websocket","polling"],
    reconnection: true,
    reconnectionAttempts: 10
  });

  // join sala privada (convenci√≥n actual)
  function unirseSalaPrivada() {
    try {
      window.socket.emit("unirse_sala_privada", { lavador_id: lavadorId });
    } catch (e) {}
  }

  // (opcional) join sala de chat si tu backend lo soporta
  let yaUnidoChat = false;
  function joinSalaChatSiListo() {
    refrescarClienteIdDesdeDOMyLS();
    if (!clienteId || clienteId === "none") return;

    const C = Number(clienteId);
    const L = Number(lavadorId);
    if (!Number.isFinite(C) || !Number.isFinite(L)) return;

    const sala = `chat_${Math.min(C, L)}_${Math.max(C, L)}`;
    if (!yaUnidoChat) {
      try { window.socket.emit("unirse_chat", { sala }); } catch (e) {}
      yaUnidoChat = true;
    }
  }

  function rejoinTodo() {
    unirseSalaPrivada();
    yaUnidoChat = false;
    joinSalaChatSiListo();
  }

  window.socket.on("connect", () => {
    rejoinTodo();
  });

  window.socket.on("disconnect", () => {
    yaUnidoChat = false;
  });

  window.addEventListener("focus", () => rejoinTodo());
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible") rejoinTodo();
  });
  window.addEventListener("pageshow", () => rejoinTodo());

  // ====== Nueva solicitud ======
  window.socket.on("nueva_solicitud", (data) => {
    try { console.log("üì® nueva_solicitud:", data); } catch (e) {}

    // si viene lavador_id, filtramos
    if (data && data.lavador_id && String(data.lavador_id) !== String(lavadorId)) return;

    if (data && data.cliente_id) {
      clienteId = String(data.cliente_id);
      try { localStorage.setItem("lm_cliente_activo", String(clienteId)); } catch (e) {}
      const cd = document.getElementById("clienteData");
      if (cd) cd.dataset.id = String(clienteId);

      const hidden = document.getElementById("clienteIdHidden");
      if (hidden) hidden.value = String(clienteId);

      yaUnidoChat = false;
      joinSalaChatSiListo();
    }

    // UI
    const cont = document.getElementById("solicitudes");
    const notif = document.getElementById("notificacion");
    if (notif) notif.style.display = "block";
    if (!cont) return;

    cont.innerHTML = "";

    const wrap = document.createElement("div");

    const strong = document.createElement("strong");
    strong.textContent = `${data.nombre || ""} ${data.apellido || ""}`.trim() || "Cliente";
    wrap.appendChild(strong);
    wrap.appendChild(document.createElement("br"));

    if (data.telefono) {
      wrap.appendChild(document.createTextNode(`Tel: ${data.telefono}`));
      wrap.appendChild(document.createElement("br"));
    }

    if (data.solicitud_id) {
      const btn = document.createElement("button");
      btn.id = `botonAceptar_${data.solicitud_id}`;
      btn.className = "aceptar";
      btn.type = "button";
      btn.textContent = "Aceptar";
      btn.addEventListener("click", () => aceptar(data.solicitud_id));
      wrap.appendChild(btn);
    }

    cont.appendChild(wrap);
  });

  // ====== Cuando el cliente cancela la solicitud ======
  window.socket.on("solicitud_cancelada", (data) => {
    try {
      const cid = data && data.cliente_id ? String(data.cliente_id) : null;
      const actual = (clienteId && clienteId !== "none") ? String(clienteId) : null;
      const guardado = localStorage.getItem("lm_cliente_activo");

      if (!cid || cid === actual || cid === String(guardado)) {
        const notif = document.getElementById("notificacion");
        if (notif) notif.style.display = "none";

        const cont = document.getElementById("solicitudes");
        if (cont) cont.innerHTML = "";

        clienteId = "none";
        const cd = document.getElementById("clienteData");
        if (cd) cd.dataset.id = "none";

        try { localStorage.removeItem("lm_cliente_activo"); } catch(e) {}

        const hidden = document.getElementById("clienteIdHidden");
        if (hidden) hidden.value = "";

        if (rutaPolyline) { rutaPolyline.setMap(null); rutaPolyline = null; }
        if (clienteMarker) { clienteMarker.setMap(null); clienteMarker = null; }
        yaUnidoChat = false;
      }
    } catch(e) {}
  });

  // ====== Cuando el cliente finaliza / califica ======
  window.socket.on("servicio_finalizado", (data) => {
    try {
      const cid = data && data.cliente_id ? String(data.cliente_id) : null;
      const actual = (clienteId && clienteId !== "none") ? String(clienteId) : null;
      const guardado = localStorage.getItem("lm_cliente_activo");

      if (!cid || cid === actual || cid === String(guardado)) {
        const notif = document.getElementById("notificacion");
        if (notif) notif.style.display = "none";

        const cont = document.getElementById("solicitudes");
        if (cont) cont.innerHTML = "";

        clienteId = "none";
        const cd = document.getElementById("clienteData");
        if (cd) cd.dataset.id = "none";

        try { localStorage.removeItem("lm_cliente_activo"); } catch(e) {}

        const hidden = document.getElementById("clienteIdHidden");
        if (hidden) hidden.value = "";

        if (rutaPolyline) { rutaPolyline.setMap(null); rutaPolyline = null; }
        if (clienteMarker) { clienteMarker.setMap(null); clienteMarker = null; }

        const cal = document.getElementById("calificaciones");
        if (cal) cal.style.display = "none";
        yaUnidoChat = false;
      }
    } catch(e) {}
  });

  // Cuando otro lavador acepta: limpiar esta solicitud aqu√≠
  window.socket.on("nueva_solicitud_aceptada", (data) => {
    if (!data) return;

    // si fui yo el que acept√≥, no limpio
    if (String(data.lavador_id) === String(lavadorId)) return;

    const clienteActual = (clienteId && clienteId !== "none") ? String(clienteId) : null;
    let clienteGuardado = null;
    try { clienteGuardado = localStorage.getItem("lm_cliente_activo"); } catch (e) {}

    if (String(data.cliente_id) === clienteActual || String(data.cliente_id) === String(clienteGuardado)) {
      const notif = document.getElementById("notificacion");
      if (notif) notif.style.display = "none";

      const cont = document.getElementById("solicitudes");
      if (cont) cont.innerHTML = "";

      clienteId = "none";
      const cd = document.getElementById("clienteData");
      if (cd) cd.dataset.id = "none";

      try { localStorage.removeItem("lm_cliente_activo"); } catch (e) {}

      const hidden = document.getElementById("clienteIdHidden");
      if (hidden) hidden.value = "";
    

      if (rutaPolyline) { rutaPolyline.setMap(null); rutaPolyline = null; }
      if (clienteMarker) { clienteMarker.setMap(null); clienteMarker = null; }
      yaUnidoChat = false;
}
  });

  // Mensajes privados: burbuja + sonido
  window.socket.on("recibir_mensaje_privado", (data) => {
    try {
      const botonChat = document.getElementById("botonChat");
      if (botonChat && !document.getElementById("burbujaChat")) {
        const burbuja = document.createElement("span");
        burbuja.id = "burbujaChat";
        burbuja.textContent = "üî¥";
        burbuja.style.marginLeft = "5px";
        botonChat.appendChild(burbuja);
      }
      const sonido = document.getElementById("sonidoMensaje");
      if (sonido) sonido.play().catch(() => {});
    } catch (e) {}
  });

  // Mantener sesi√≥n viva
  try {
    setInterval(() => {
      fetch("/ping", { method: "GET", credentials: "include", cache: "no-store" }).catch(()=>{});
    }, 120000);
  } catch (e) {}
</script>

<script>
  // ====== Mapa ======
  let map, lavadorMarker, clienteMarker, rutaPolyline;
  let watchId = null;

  function actualizarUbicacion(lat, lng) {
    // socket
    try {
      window.socket.emit("ubicacion_lavador", {
        lavador_id: lavadorId,
        latitud: lat,
        longitud: lng
      });
    } catch (e) {}

    // backend
    fetch(`/actualizar_ubicacion_lavador?lat=${lat}&lng=${lng}`, {
      credentials: "include"
    }).catch(() => {});
  }

  function trazarRutaSiSePuede() {
    if (!clienteMarker || !lavadorMarker || !map) return;

    if (rutaPolyline) rutaPolyline.setMap(null);
    rutaPolyline = new google.maps.Polyline({
      path: [lavadorMarker.getPosition(), clienteMarker.getPosition()],
      geodesic: true,
      strokeColor: "#00bfff",
      strokeOpacity: 1.0,
      strokeWeight: 3,
      map: map
    });
  }

  function obtenerUbicacionCliente() {
    refrescarClienteIdDesdeDOMyLS();
    if (!clienteId || clienteId === "none") return;

    fetch(`/obtener_ubicacion_cliente?user_id=${clienteId}`, { credentials: "include" })
      .then(res => res.json())
      .then(data => {
        if (!data || typeof data.lat !== "number" || typeof data.lng !== "number") return;

        const pos = { lat: data.lat, lng: data.lng };

        if (!clienteMarker) {
          clienteMarker = new google.maps.Marker({
            position: pos,
            map: map,
            title: "Cliente",
            icon: { url: "/static/icons/carrito_icono.png", scaledSize: new google.maps.Size(50, 50) }
          });
        } else {
          clienteMarker.setPosition(pos);
        }

        trazarRutaSiSePuede();
      })
      .catch(() => {});
  }

  function iniciarGPSLavador() {
    if (!navigator.geolocation) return;

    if (watchId) {
      try { navigator.geolocation.clearWatch(watchId); } catch (e) {}
      watchId = null;
    }

    watchId = navigator.geolocation.watchPosition(
      (pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const nuevaPos = { lat, lng };

        if (!lavadorMarker) {
          lavadorMarker = new google.maps.Marker({
            position: nuevaPos,
            map: map,
            title: "Tu ubicaci√≥n",
            icon: { url: "/static/icons/camioncito_icono.png", scaledSize: new google.maps.Size(50, 50) }
          });
        } else {
          lavadorMarker.setPosition(nuevaPos);
        }

        map.setCenter(nuevaPos);
        actualizarUbicacion(lat, lng);
        trazarRutaSiSePuede();
      },
      () => {},
      { enableHighAccuracy: true, maximumAge: 10000, timeout: 15000 }
    );
  }

  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 18.4861, lng: -69.9312 }, // fallback RD
      zoom: 15
    });

    refrescarClienteIdDesdeDOMyLS();

    // trae cliente al iniciar
    obtenerUbicacionCliente();
    setInterval(obtenerUbicacionCliente, 8000);

    // permiso ubicaci√≥n (desactivado en m√≥vil por cierres)
     //const permiso = confirm("üöó LavaMovil necesita acceso a tu ubicaci√≥n para encontrar al cliente. ¬øDeseas permitirlo?");
     //if (permiso) iniciarGPSLavador();
     iniciarGPSLavador();
  }

  window.initMap = initMap;
</script>

<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBmVCNKb_sjx-vE5b1YoJpPUgm8Ub09ElE&callback=initMap">
</script>

<script>
  // ====== Aceptar solicitud ======
  function aceptar(id) {
    fetch(`/aceptar_solicitud?solicitud_id=${id}`, {
      method: "GET",
      credentials: "include",
      cache: "no-store"
    })
    .then(res => res.ok ? res.json() : Promise.reject(res))
    .then(res => {
      if (res && (res.message || res.error)) alert(res.message || res.error);

      const btn = document.getElementById(`botonAceptar_${id}`);
      if (btn) btn.style.display = "none";

      if (res && res.cliente_id) {
        clienteId = String(res.cliente_id);
        try { localStorage.setItem("lm_cliente_activo", String(clienteId)); } catch (e) {}

        const cd = document.getElementById("clienteData");
        if (cd) cd.dataset.id = String(clienteId);

        const hidden = document.getElementById("clienteIdHidden");
        if (hidden) hidden.value = String(clienteId);

        yaUnidoChat = false;
        joinSalaChatSiListo();
      }

      // por seguridad, rejoin sala privada
      unirseSalaPrivada();

      // inicia movimiento (si tu backend lo usa)
      iniciarMovimientoManual(id);
    })
    .catch(err => console.error("‚úò aceptar_solicitud:", err.status || err, err.statusText || ""));
  }
  window.aceptar = aceptar;

  function iniciarMovimientoManual(solicitudId) {
    fetch(`/obtener_ids_por_solicitud?solicitud_id=${solicitudId}`, { credentials: "include" })
      .then(res => res.json())
      .then(data => {
        if (!data) return;
        const cid = data.cliente_id;
        const lid = data.lavador_id;

        if (cid) {
          clienteId = String(cid);
          try { localStorage.setItem("lm_cliente_activo", String(clienteId)); } catch (e) {}
        }

        try {
          window.socket.emit("iniciar_movimiento", { cliente_id: cid, lavador_id: lid });
        } catch (e) {}
      })
      .catch(() => {});
  }

  // ====== Botones ======
  function cambiarEstado(estado) {
    fetch("/cambiar_estado", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ estado }),
      credentials: "include",
      cache: "no-store"
    })
    .then(r => {
      if (!r.ok) throw new Error("HTTP " + r.status);
      document.getElementById("estadoServicio").innerText = estado.charAt(0).toUpperCase() + estado.slice(1);
    })
    .catch(() => alert("‚ùå Error al cambiar el estado."));
  }

  function cerrarSesion() { window.location.href = "/logout"; }

  function verCalificaciones() {
    fetch(`/ver_calificaciones/${lavadorId}`)
      .then(r => r.json())
      .then(data => {
        const div = document.getElementById("calificaciones");
        div.innerHTML = "<h3>Calificaciones</h3>";
        if (!data || data.length === 0) {
          div.innerHTML += "<p>No tienes calificaciones a√∫n.</p>";
        } else {
          data.forEach(item => {
            div.innerHTML += `<p><strong>${item.nombre} ${item.apellido}:</strong> ${item.calificacion} - ${item.comentario}</p>`;
          });
        }
        div.style.display = "block";
      })
      .catch(() => {});
  }
</script>

</body>
</html>
