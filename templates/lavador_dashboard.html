<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel del Lavador - LavaMovil</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<style>
    body { font-family: 'Segoe UI', sans-serif; background-color: #121212; color: #ffffff; margin: 0; padding: 0; text-align: center; }
    h1 { color: #ffffff; font-size: 24px; margin-top: 20px; } p { color: #ffffff; } #estado { color: #ffffff; }
    #map { width: 90%; max-width: 360px; height: 250px; border-radius: 20px; margin: 20px auto; border: 1px solid #333; box-shadow: 0 4px 10px rgba(0,0,0,0.4); }
    button { display: flex; align-items: center; justify-content: center; width: 85%; max-width: 320px; margin: 10px auto; padding: 14px; border: 2px solid #aaa; border-radius: 30px; font-size: 16px; font-weight: 600; color: white; cursor: pointer; transition: all 0.3s ease; box-sizing: border-box; }

    .activo { background-color: #28a745; }
    .inactivo { background-color: #dc3545; }
    .cerrar { background-color: #343a40; }
    .vercal { background-color: #007bff; }
    .activo:hover { background-color: #1c7c31; }
    .inactivo:hover { background-color: #a71d2a; }    
    .cerrar:hover { background-color: #1d2124; }
    .vercal:hover { background-color: #0056b3; }
    #franjaSolicitud {
      display: none;
      background-color: #ffc107;
      padding: 15px;
      border-radius: 0 0 15px 15px;
      color: #000;
      margin-bottom: 10px;
      font-weight: bold;
    }

    #estado { margin-bottom: 10px; font-size: 15px; color: #ffffff; }
    .calificacion-box { background-color: #1e1e1e; border: 1px solid #555; margin: 20px auto; padding: 15px; border-radius: 12px; max-width: 360px; text-align: left; display: none; color: #ffffff; box-sizing: border-box; width: 85%; }
    .aceptar {
      background-color: #28a745;
      color: white;
      padding: 10px 18px;
      border: none;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 8px;
    }
    .aceptar:hover {
      background-color: #1c7c31;
    }
    select, textarea { width: 100%; max-width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px; border: 1px solid #555; font-size: 14px; background-color: #2a2a2a; color: #ffffff; box-sizing: border-box; }
  </style>
</head>
<body>

{% include 'notificaciones.html' %}

<h1>Bienvenido Lavador {{ lavador.nombre }} {{ lavador.apellido }}</h1>
<p>ID de Usuario: {{ lavador.id }}</p>
<div id="estado">Estado: <span id="estadoServicio">{{ lavador.estado.capitalize() }}</span></div>
<div id="clienteData" data-id="{{ cliente.id if cliente else 'none' }}"></div>
<div id="solicitudAceptada" data-estado="{{ 'true' if solicitud_aceptada else 'false' }}"></div>
<div id="estadoSolicitud" data-aceptada="{{ 'true' if solicitud_activa and solicitud_activa.estado == 'aceptado' else 'false' }}"></div>


<div id="franjaSolicitud">üü° Nueva solicitud recibida</div>
<div id="map"></div>

<button class="activo" onclick="cambiarEstado('activo')">üîî Activar</button>
<button class="inactivo" onclick="cambiarEstado('inactivo')">üîï Desactivar</button>
<button class="vercal" onclick="verCalificaciones()">‚≠ê Ver Calificaciones</button>
<button class="cerrar" onclick="cerrarSesion()">‚õî Cerrar Sesi√≥n</button>

<form action="/chat" method="get">
  <input type="hidden" name="rol" value="lavador">
  <button id="botonChat" type="submit" style="background-color: #6c63ff; color: white; padding: 10px; border-radius: 10px;">
    üí¨ Chat con Cliente
  </button>
</form>

<script>
function abrirChat() {
  const lavadorId = {{ lavador.id }};
  if (clienteId !== "none" ) {
    window.location.href = `/chat_privado/${clienteId}/${lavadorId}`;
  } else {
    alert("‚ùå No hay una solicitud activa.");
  }
}
</script>

<div id="solicitudes"></div>
<div id="calificaciones" class="calificacion-box"></div>
<audio id="sonidoMensaje" src="/static/sounds/nuevo_mensaje.mp3"></audio>

<!-- üîß INICIO PARCHE FRONT -->
<script>
  const socket = io(window.location.origin, {
    transports: ["websocket","polling"],
    reconnection: true,
    reconnectionAttempts: 10
  });

  const lavadorId = {{ lavador.id|tojson }};

  // üîß INICIO CAMBIO: clienteId persistente + tracking de solicitud actual
  let clienteId = (localStorage.getItem('clienteId_actual') || (document.getElementById('clienteData')?.dataset.id) || 'none');
  if (clienteId === 'null' || clienteId === 'undefined') clienteId = 'none';
  let solicitudActualId = null;
  // üîß FIN CAMBIO


  socket.on("connect", () => {
    console.log("üü¢ Socket conectado:", socket.id);
    socket.emit("unirse_sala_privada", { lavador_id: lavadorId });
  });

  socket.on("union_confirmada", (d) => {
    console.log("‚úÖ Unido a sala:", d && d.sala ? d.sala : d);
   // No mostrar franja aqu√≠. La franja amarilla es SOLO para nueva_solicitud. 
  });
    
  // üîß INICIO CAMBIO: limpieza inmediata en otros lavadores
  socket.on('nueva_solicitud_aceptada', (data) => {
    try {
      if (!data) return;
      if (solicitudActualId && data.solicitud_id && String(data.solicitud_id) !== String(solicitudActualId)) return;

      // Si otro lavador acept√≥ ESTA solicitud, limpiamos la franja + bot√≥n
      if (data.lavador_id && String(data.lavador_id) !== String(lavadorId)) {
        console.log('üßπ Otra persona acept√≥ la solicitud. Limpiando UI...');
        solicitudActualId = null;
        clienteId = 'none';
        localStorage.removeItem('clienteId_actual');
        const cd = document.getElementById('clienteData');
        if (cd) cd.dataset.id = 'none';
        const n = document.getElementById('notificacion');
        if (n) n.style.display = 'none';
        const s = document.getElementById('solicitudes');
        if (s) s.innerHTML = '';
      }
    } catch (e) {
      console.warn('nueva_solicitud_aceptada error:', e);
    }
  });

  socket.on('solicitud_cancelada', (data) => {
    try {
      if (!data) return;
      if (solicitudActualId && data.solicitud_id && String(data.solicitud_id) !== String(solicitudActualId)) return;
      console.log('üßπ Solicitud cancelada. Limpiando UI...');
      solicitudActualId = null;
      clienteId = 'none';
      localStorage.removeItem('clienteId_actual');
      const cd = document.getElementById('clienteData');
      if (cd) cd.dataset.id = 'none';
      const n = document.getElementById('notificacion');
      if (n) n.style.display = 'none';
      const s = document.getElementById('solicitudes');
      if (s) s.innerHTML = '';
    } catch (e) {
      console.warn('solicitud_cancelada error:', e);
    }
  });
  // üîß FIN CAMBIO

socket.on("nueva_solicitud", function(data) {
  console.log("üì® Solicitud recibida del cliente:", data);
  solicitudActualId = data && data.solicitud_id ? data.solicitud_id : null;

  // ‚úÖ Ya NO filtramos por data.lavador_id (porque ahora viene por broadcast)
  console.log("‚úÖ Mostrando solicitud a este lavador y uni√©ndome a mi sala privada");

  // üîÑ Actualizar clienteId din√°micamente al recibir solicitud
  const clienteDataEl = document.getElementById("clienteData");
  if (clienteDataEl) clienteDataEl.dataset.id = data.cliente_id;

  clienteId = data.cliente_id;
  try { localStorage.setItem('clienteId_actual', String(clienteId)); } catch(e) {}
  console.log("üîÑ clienteId actualizado din√°micamente:", clienteId);

  // ‚úÖ Unirse a la sala privada DEL LAVADOR (para chat/actualizaciones)
  socket.emit("unirse_sala_privada", { lavador_id: lavadorId });

  // UI: mostrar la solicitud
  document.getElementById("solicitudes").innerHTML = ""; // Limpia solicitudes anteriores
  const div = document.createElement('div');
  div.innerHTML = `
    <div>
      <strong>${data.nombre} ${data.apellido}</strong><br>
      Tel: ${data.telefono}<br>
      <button id="botonAceptar_${data.solicitud_id}" class="aceptar" onclick="aceptar(${data.solicitud_id})">Aceptar</button>
    </div>`;
  document.getElementById("solicitudes").appendChild(div);

  // ‚úÖ Franja amarilla: debe quedarse hasta aceptar/cancelar (no la ocultes aqu√≠)
  const franja = document.getElementById("franjaSolicitud");
  if (franja) {
    franja.style.display = "block";
    franja.innerText = "üü° Nueva solicitud recibida";
    franja.style.opacity = "1";
  }

  // ‚úÖ Solo inicia si no est√° ya corriendo
  if (!intervaloCliente) {
    intervaloCliente = setInterval(() => {
      if (clienteId !== "none") {
        obtenerUbicacionCliente();
      } else {
        console.warn("‚ö†Ô∏è clienteId inv√°lido:", clienteId);
      }
    }, 5000);
  }
});

</script>

<!-- üîß INICIO CAMBIO: MAPA LAVADOR (restaurado) -->
<script>
  let map = null;
  let lavadorMarker = null;
  let clienteMarker = null;
  let rutaPolyline = null;
  let intervaloCliente = null;

  function actualizarUbicacion(lat, lng) {
    try {
      socket.emit("ubicacion_lavador", { lavador_id: lavadorId, latitud: lat, longitud: lng });
    } catch(e) {}

    fetch(`/actualizar_ubicacion_lavador?lat=${lat}&lng=${lng}`, { credentials: 'include' })
      .then(res => res.json())
      .catch(() => {});

    // Dibujar ruta si ya tenemos ambos marcadores
    if (clienteMarker && lavadorMarker) {
      if (rutaPolyline) rutaPolyline.setMap(null);
      rutaPolyline = new google.maps.Polyline({
        path: [lavadorMarker.getPosition(), clienteMarker.getPosition()],
        geodesic: true,
        strokeOpacity: 1.0,
        strokeWeight: 3,
        map: map
      });
    }
  }

  function obtenerUbicacionCliente() {
    if (!clienteId || clienteId === 'none') return;

    fetch(`/obtener_ubicacion_cliente?user_id=${clienteId}`, { credentials: 'include' })
      .then(res => res.json())
      .then(data => {
        if (!data || data.error) return;
        if (data.lat && data.lng) {
          const pos = { lat: data.lat, lng: data.lng };
          if (!clienteMarker) {
            clienteMarker = new google.maps.Marker({
              position: pos,
              map: map,
              title: 'Cliente',
              icon: { url: '/static/icons/carrito_icono.png', scaledSize: new google.maps.Size(50, 50) }
            });
          } else {
            clienteMarker.setPosition(pos);
          }

          if (clienteMarker && lavadorMarker) {
            if (rutaPolyline) rutaPolyline.setMap(null);
            rutaPolyline = new google.maps.Polyline({
              path: [lavadorMarker.getPosition(), clienteMarker.getPosition()],
              geodesic: true,
              strokeOpacity: 1.0,
              strokeWeight: 3,
              map: map
            });
          }
        }
      })
      .catch(() => {});
  }

  function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
      center: { lat: 19.4326, lng: -99.1332 },
      zoom: 15
    });

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const myPos = { lat, lng };

        lavadorMarker = new google.maps.Marker({
          position: myPos,
          map: map,
          title: 'Tu ubicaci√≥n',
          icon: { url: '/static/icons/camioncito_icono.png', scaledSize: new google.maps.Size(50, 50) }
        });

        map.setCenter(myPos);
        actualizarUbicacion(lat, lng);
        obtenerUbicacionCliente();

        // refrescar ubicaci√≥n del lavador cada 5s
        setInterval(() => {
          navigator.geolocation.getCurrentPosition(p2 => {
            const la = p2.coords.latitude;
            const lo = p2.coords.longitude;
            if (lavadorMarker) lavadorMarker.setPosition({ lat: la, lng: lo });
            actualizarUbicacion(la, lo);
          });
        }, 5000);

      }, () => {
        // fallback
        const fb = { lat: 18.4861, lng: -69.9312 };
        lavadorMarker = new google.maps.Marker({
          position: fb,
          map: map,
          title: 'Ubicaci√≥n simulada',
          icon: { url: '/static/icons/camioncito_icono.png', scaledSize: new google.maps.Size(50, 50) }
        });
        map.setCenter(fb);
      }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
    }

    // refrescar posici√≥n del cliente cada 5s si hay cliente
    if (!intervaloCliente) {
      intervaloCliente = setInterval(() => {
        if (clienteId && clienteId !== 'none') {
          obtenerUbicacionCliente();
        }
      }, 5000);
    }
  }

  window.initMap = initMap;
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBmVCNKb_sjx-vE5b1YoJpPUgm8Ub09ElE&callback=initMap"></script>
<!-- üîß FIN CAMBIO: MAPA LAVADOR -->

<script>
function aceptar(id) { 
  fetch(`/aceptar_solicitud?solicitud_id=${id}`)
    .then(res => res.json())
    .then(res => {
      alert(res.message || res.error);

      const botonAceptar = document.getElementById(`botonAceptar_${id}`);
      if (botonAceptar) {
        botonAceptar.style.display = "none";
      }

      // üîß INICIO PARCHE: ocultar franja de nueva solicitud
      const franja = document.getElementById("franjaSolicitud");
      if (franja) {
        franja.style.display = "none";
      }
      // üîß FIN PARCHE

      iniciarMovimientoManual(id);  // Sigue normal

      // üîß INICIO CAMBIO: persistir clienteId para volver del chat
      try {
        if (clienteId && clienteId !== "none") {
          localStorage.setItem("clienteId_actual", String(clienteId));
        }
      } catch (e) {}
      // üîß FIN CAMBIO
      // ‚ùå location.reload(); ‚Üí ELIMINADO
    });
}

function iniciarMovimientoManual(solicitudId) {
  fetch(`/obtener_ids_por_solicitud?solicitud_id=${solicitudId}`)
    .then(res => res.json())
    .then(data => {
      const clienteId = data.cliente_id;
      const lavadorId = data.lavador_id;

      // Emitimos el evento al cliente
      socket.emit("iniciar_movimiento", {
        cliente_id: clienteId,
        lavador_id: lavadorId
      });

      console.log("üì§ Movimiento iniciado para cliente:", clienteId, "lavador:", lavadorId);
    })
    .catch(err => {
      console.error("‚ùå Error al iniciar movimiento:", err);
    });
}

function cambiarEstado(estado) {
  fetch('/cambiar_estado', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ estado: estado })
  })
  .then(response => {
    if (response.ok) {
      document.getElementById("estadoServicio").innerText = estado.charAt(0).toUpperCase() + estado.slice(1);
      alert("Estado actualizado a: " + estado);
    } else {
      alert("‚ùå Error al cambiar el estado.");
    }
  });
}

function cerrarSesion() {
  window.location.href = "/logout";
}

function volverInicio() {
  window.location.href = "/";
}

function verCalificaciones() {
  fetch(`/ver_calificaciones/${lavadorId}`)
    .then(response => response.json())
    .then(data => {
      const div = document.getElementById("calificaciones");
      div.innerHTML = "<h3>Calificaciones</h3>";
      if (data.length === 0) {
        div.innerHTML += "<p>No tienes calificaciones a√∫n.</p>";
      } else {
        data.forEach(item => {
          div.innerHTML += `<p><strong>${item.nombre} ${item.apellido}:</strong> ${item.calificacion} - ${item.comentario}</p>`;
        });
      }
      div.style.display = "block";
    });
}
</script>

<script>
socket.emit("unirse_sala_mensajes", { user_id: lavadorId });
socket.on("nuevo_mensaje_directo", function(data) {
  if (data.destinatario_id === lavadorId) {
    const botonChat = document.getElementById("botonChat");
    if (botonChat && !document.getElementById("burbujaChat")) {
      const burbuja = document.createElement("span");
      burbuja.id = "burbujaChat";
      burbuja.textContent = "üî¥";
      burbuja.style.marginLeft = "5px";
      botonChat.appendChild(burbuja);
    }
    const sonido = document.getElementById("sonidoMensaje");
    if (sonido) sonido.play();
  }
});

document.addEventListener('click', () => {
  const sonido = document.getElementById("sonidoMensaje");
  if (sonido) sonido.play().catch(() => {});
}, { once: true });

setInterval(() => {
  fetch("/verificar_mensajes_nuevos")
    .then(res => res.json())
    .then(data => {
      if (data.mensajes_nuevos && !document.getElementById("burbujaChat")) {
        const burbuja = document.createElement("span");
        burbuja.textContent = "üî¥";
        burbuja.id = "burbujaChat";
        burbuja.style.marginLeft = "5px";
        const boton = document.getElementById("botonChat");
        if (boton) boton.appendChild(burbuja);
      }
    });
}, 5000);
    
socket.on("actualizar_ubicacion_cliente", (data) => {
  const posicionCliente = { lat: data.latitud, lng: data.longitud };

  if (!clienteMarker) {
    clienteMarker = new google.maps.Marker({
      position: posicionCliente,
      map: map,
      title: "Cliente",
      icon: {
        url: "/static/icons/carrito_icono.png",
        scaledSize: new google.maps.Size(40, 40)
      }
    });
  } else {
    clienteMarker.setPosition(posicionCliente);
  }
});
</script>

</body>
</html>
